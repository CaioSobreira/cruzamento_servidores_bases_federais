<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>AuditaSocial - Ferramenta de Auditoria</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a3a6c;
            --secondary: #2c5282;
            --accent: #0ea5e9;
            --light: #f8fafc;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray: #64748b;
        }
        
        body {
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f2ff 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #334155;
            padding-bottom: 40px;
            min-height: 100vh;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .header-container {
            position: relative;
            margin-bottom: 30px;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .banner {
            width: 100%;
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background: linear-gradient(135deg, #1a3a6c 0%, #2c5282 100%);
            position: relative;
            overflow: hidden;
            padding: 0 20px;
            text-align: center;
        }
        
        .banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at top right, rgba(14, 165, 233, 0.3) 0%, transparent 40%);
        }
        
        .banner-content {
            position: relative;
            z-index: 2;
            max-width: 800px;
            padding: 30px 0;
        }
        
        .banner h1 {
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .banner p {
            font-size: 1.2rem;
            font-weight: 300;
            max-width: 600px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        .section-title {
            position: relative;
            padding-bottom: 15px;
            margin-bottom: 25px;
            color: var(--primary);
            font-weight: 700;
        }
        
        .section-title:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 70px;
            height: 4px;
            background: var(--accent);
            border-radius: 2px;
        }
        
        .stat-card {
            border-radius: 12px;
            overflow: hidden;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            background: white;
            text-align: center;
            padding: 25px 15px;
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--accent);
            background: rgba(14, 165, 233, 0.1);
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin: 0 auto 15px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
            color: var(--primary);
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.95rem;
        }
        
        .action-card {
            border-radius: 12px;
            overflow: hidden;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            height: 100%;
            background: white;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .action-card .card-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-weight: 600;
            padding: 18px 25px;
            border-bottom: none;
            font-size: 1.1rem;
        }
        
        .action-card .card-body {
            padding: 25px;
        }
        
        .btn-action {
            background: linear-gradient(135deg, var(--accent) 0%, #0d94d7 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: white;
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.3);
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(14, 165, 233, 0.4);
        }
        
        .btn-action i {
            margin-right: 8px;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dashboard-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .file-upload-box {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            background: #f8fafc;
            margin-bottom: 20px;
        }
        
        .model-box {
            background: linear-gradient(135deg, #e0f2fe 0%, #d1e9ff 100%);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            border: 1px solid #c2e0ff;
        }
        
        .table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-weight: 600;
        }
        
        .table-striped>tbody>tr:nth-of-type(odd)>* {
            background-color: #f8fafc;
        }
        
        .footer {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 30px 0;
            margin-top: 50px;
            border-top: 4px solid var(--accent);
            font-size: 0.9rem;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .status-icon {
            margin-right: 10px;
            font-size: 1.3rem;
        }
        
        .status-not-updated {
            background-color: #fee2e2;
            color: #b91c1c;
            border-left: 4px solid #b91c1c;
        }
        
        .status-in-progress {
            background-color: #fffbeb;
            color: #b45309;
            border-left: 4px solid #f59e0b;
        }
        
        .status-updated {
            background-color: #dcfce7;
            color: #15803d;
            border-left: 4px solid #10b981;
        }
        
        .benefit-tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-right: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tag-bf {
            background: rgba(14, 165, 233, 0.2);
            color: #0c4a6e;
            border: 1px solid rgba(14, 165, 233, 0.3);
        }
        
        .tag-bpc {
            background: rgba(16, 185, 129, 0.2);
            color: #065f46;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .tag-defeso {
            background: rgba(245, 158, 11, 0.2);
            color: #854d0e;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .model-header {
            margin-bottom: 20px;
        }
        
        .model-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .model-subtitle {
            font-size: 1.05rem;
            color: #1e40af;
            font-weight: 500;
        }
        
        .countdown {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            margin-top: 10px;
            background: rgba(14, 165, 233, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            display: inline-block;
        }
        
        .info-text {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .placeholder-value {
            color: #94a3b8;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .action-card {
                margin-bottom: 25px;
            }
            
            .banner h1 {
                font-size: 2.2rem;
            }
            
            .banner p {
                font-size: 1rem;
            }
            
            .stat-value {
                font-size: 1.6rem;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Banner -->
        <div class="header-container">
            <div class="banner">
                <div class="banner-content">
                    <h1>AUDITASOCIAL</h1>
                    <p>Ferramenta de auditoria para identificação de casos de fraude no cruzamento de servidores públicos e beneficiários de programas federais</p>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="stat-value" id="total-records">--</div>
                    <div class="stat-label">Registros totais</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-value" id="last-update">--</div>
                    <div class="stat-label">Última atualização</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="stat-value" id="total-finds">--</div>
                    <div class="stat-label">Achados totais</div>
                </div>
            </div>
        </div>
        
        <!-- Ações Section -->
        <h2 class="section-title mt-5">Ações</h2>
        
        <div class="row">
            <!-- Atualizar Base de Servidores (Primeiro) -->
            <div class="col-md-4 mb-4">
                <div class="action-card">
                    <div class="card-header">
                        <i class="fas fa-upload me-2"></i> Atualizar Base de Servidores
                    </div>
                    <div class="card-body">
                        <div class="file-upload-box">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <p class="mb-3">Selecione um arquivo (.csv, .xls, .xlsx)</p>
                            <input class="form-control" type="file" id="arquivo" accept=".csv, .xls, .xlsx" required>
                        </div>
                        <button class="btn btn-action text-white" onclick="enviarPlanilhaServidores()">
                            <span id="spinner_btn_upload_servidor" style="display: none;" class="spinner"></span>
                            <i class="fas fa-paper-plane"></i> Enviar Arquivo
                        </button>
                        <div id="status-upload" class="mt-3 text-center"></div>
                        
                        <!-- Status Indicator -->
                        <div class="status-indicator status-not-updated" id="server-status">
                            <i class="fas fa-exclamation-circle status-icon"></i>
                            <span>Base de servidores não atualizada</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Atualização de Bases Sociais (Segundo) -->
            <div class="col-md-4 mb-4">
                <div class="action-card">
                    <div class="card-header">
                        <i class="fas fa-sync-alt me-2"></i> Atualização de Bases Sociais
                    </div>
                    <div class="card-body">
                        <p class="info-text">Esta função atualiza as bases de benefícios federais a partir das fontes oficiais mais recentes. Recomendamos executar esta atualização mensalmente para manter os dados atualizados.</p>
                        <p class="info-text"><strong>Obs.:</strong> As bases são grandes e podem levar alguns minutos para carregamento.</p>
                        <button type="button" class="btn btn-action text-white" onclick="atualizarBaseFederal();">
                            <span id="spinner_atualizar_base_social" style="display: none;" class="spinner"></span>
                            <i class="fas fa-redo"></i> Atualizar Bases
                        </button>
                        
                        <!-- Status Indicator -->
                        <div class="status-indicator status-not-updated" id="social-status">
                            <i class="fas fa-exclamation-circle status-icon"></i>
                            <span>Bases sociais não atualizadas</span>
                        </div>
                        
                        <!-- Countdown -->
                        <div id="countdown-container" class="countdown" style="display: none;">
                            Atualização será concluída em: <span id="countdown">10:00</span>
                        </div>
                        
                        <div class="mt-4">
                            <span class="benefit-tag tag-bf">Bolsa Família</span>
                            <span class="benefit-tag tag-bpc">BPC</span>
                            <span class="benefit-tag tag-defeso">Seguro-Defeso</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Realizar Cruzamento (Terceiro) -->
            <div class="col-md-4 mb-4">
                <div class="action-card">
                    <div class="card-header">
                        <i class="fas fa-cogs me-2"></i> Realizar Cruzamento
                    </div>
                    <div class="card-body">
                        <p class="info-text">Executa o cruzamento entre a base de servidores públicos e as bases de benefícios federais, identificando possíveis casos de fraude.</p>
                        <button type="button" class="btn btn-action text-white" onclick="chamarCruzamento();">
                            <span id="spinner_atualizar_cruzamento" style="display: none;" class="spinner"></span>
                            <i class="fas fa-play-circle"></i> Executar Cruzamento
                        </button>
                        
                        <!-- Status Indicator -->
                        <div class="status-indicator status-not-updated" id="cross-status">
                            <i class="fas fa-exclamation-circle status-icon"></i>
                            <span>Nenhum cruzamento realizado ainda</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modelos Section -->
        <div class="model-box">
            <div class="model-header">
                <h5 class="model-title"><i class="fas fa-file-download me-2"></i> Modelos de Arquivos</h5>
                <div class="model-subtitle">Precisa de um modelo para atualizar a base de servidores?</div>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-outline-primary" href="{{ url_for('download', filename='servidores_cruzamento.xlsx') }}">
                    <i class="fas fa-file-excel me-2"></i> Baixar modelo (.xlsx)
                </a>
                <a class="btn btn-outline-primary" href="{{ url_for('download', filename='servidores_cruzamento.csv') }}">
                    <i class="fas fa-file-csv me-2"></i> Baixar modelo (.csv)
                </a>
                <a class="btn btn-outline-primary" href="{{ url_for('download', filename='servidores_cruzamento.xls') }}">
                    <i class="fas fa-file-excel me-2"></i> Baixar modelo (.xls)
                </a>
            </div>
        </div>
        
        <!-- Tabela de Cargas -->
        <div class="dashboard-section">
            <h2 class="section-title">Tabela de Cargas</h2>
            <div class="table-responsive">
              <table class="table table-bordered table-hover table-striped align-middle">
                <thead class="table-dark">
                  <tr>
                    <th style="text-align: center;">Data de Atualização</th>
                    <th style="text-align: center;">Nome da Carga</th>
                    <th style="text-align: center;">Quantidade de Registros</th>
                  </tr>
                </thead>
                <tbody id="tabela-cargas">
                  <!-- Data will be loaded here -->
                </tbody>
              </table>
            </div>
        </div>

        <!-- Resultados de Cruzamentos -->
        <div class="dashboard-section">
            <h2 class="section-title">Resultados de Cruzamentos</h2>
            
            <div class="chart-container">
                <canvas id="myChart"></canvas>
            </div>

            <div class="table-responsive">
              <table class="table table-bordered table-hover table-striped align-middle">
                <thead class="table-dark">
                  <tr>
                    <th style="text-align: center;">Data do Cruzamento</th>
                    <th style="text-align: center;">Cruzamento</th>
                    <th style="text-align: center;">Quantidade de Achados</th>
                  </tr>
                </thead>
                <tbody id="tabela-cruzamentos">
                  <!-- Data will be loaded here -->
                </tbody>
              </table>
            </div>
            
            <div class="text-center mt-4">
                <a class="btn btn-action btn-lg text-white" href="{{ url_for('planilha_resultados', filename='resultados_cruzamentos.xlsx') }}">
                    <i class="fas fa-download"></i> Baixar Resultados Completos
                </a>
            </div>
        </div>
        
        <div class="footer">
            <div class="app-container">
                <div class="row">
                    <div class="col-md-12 text-center">
                        <p class="mb-1">© 2025 AuditaSocial. LIMA, Caio; PERRUCCI, Marcelo L.; e FREITAS, Rafael.</p>
                        <p class="mb-0">Última versão disponível em <a href="https://github.com/CaioSobreira/cruzamento_servidores_bases_federais" class="text-white">https://github.com/CaioSobreira/cruzamento_servidores_bases_federais</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Variáveis globais
        let countdownInterval;
        let countdownSeconds = 600; // 10 minutos
        let myChart = null;

        // =================================================================================================
        // CARREGA A GRÁFICO DE ACHADOS (APENAS 3 BENEFÍCIOS)
        // =================================================================================================
        async function carregarGraficoAchados(data) {
            const ctx = document.getElementById('myChart');
            
            // Destruir gráfico anterior se existir
            if (myChart) {
                myChart.destroy();
            }
            
            // Se não houver dados, mostrar gráfico vazio
            if (!data || data.length === 0) {
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ["Bolsa Família", "BPC", "Seguro-Defeso"],
                        datasets: [{
                            label: 'Quantidades de Achados no Cruzamento',
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(14, 165, 233, 0.7)',   // Bolsa Família
                                'rgba(16, 185, 129, 0.7)',    // BPC
                                'rgba(245, 158, 11, 0.7)'     // Seguro-Defeso
                            ],
                            borderColor: [
                                'rgb(14, 165, 233)',
                                'rgb(16, 185, 129)',
                                'rgb(245, 158, 11)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Distribuição de Achados por Benefício',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('pt-BR');
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Quantidade de Achados',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Benefício',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    }
                });
                return;
            }

            let data_label = [];
            let data_values = [];

            // Filtrar apenas os 3 benefícios específicos
            const beneficiosPermitidos = ["Bolsa Família", "BPC", "Seguro-Defeso"];
            const dadosFiltrados = data.filter(row => beneficiosPermitidos.includes(row.base));
            
            // Ordenar de acordo com a lista de benefícios permitidos
            beneficiosPermitidos.forEach(beneficio => {
                const dado = dadosFiltrados.find(row => row.base === beneficio);
                if (dado) {
                    data_label.push(dado.base);
                    data_values.push(dado.qtd);
                } else {
                    data_label.push(beneficio);
                    data_values.push(0);
                }
            });

            try {
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data_label,
                        datasets: [{
                            label: 'Quantidades de Achados no Cruzamento',
                            data: data_values,
                            backgroundColor: [
                                'rgba(14, 165, 233, 0.7)',   // Bolsa Família
                                'rgba(16, 185, 129, 0.7)',    // BPC
                                'rgba(245, 158, 11, 0.7)'     // Seguro-Defeso
                            ],
                            borderColor: [
                                'rgb(14, 165, 233)',
                                'rgb(16, 185, 129)',
                                'rgb(245, 158, 11)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Distribuição de Achados por Benefício',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('pt-BR');
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Quantidade de Achados',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Benefício',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Erro ao carregar gráfico de barras:', error);
            }
        }

        // =================================================================================================
        // CHAMAR CRUZAMENTO DE DADOS ENTRE BASES
        // =================================================================================================
        async function chamarCruzamento() {
            const id_spinner = "spinner_atualizar_cruzamento";
            
            spinner_habilitar(id_spinner);
            
            // Atualizar status para "em progresso"
            document.getElementById('cross-status').innerHTML = `
                <i class="fas fa-sync-alt fa-spin status-icon"></i>
                <span>Cruzamento em andamento...</span>
            `;
            document.getElementById('cross-status').className = 'status-indicator status-in-progress';

            try {
                const response = await fetch('/cruzamento');

                if (!response.ok) {
                    throw new Error('Erro ao buscar os dados');
                }

                const data = await response.json();
                console.log(data);

                await carregarTabelaCruzamentos();
                
                // Atualizar status para sucesso
                document.getElementById('cross-status').innerHTML = `
                    <i class="fas fa-check-circle status-icon"></i>
                    <span>Cruzamento realizado com sucesso (${new Date().toLocaleDateString()})</span>
                `;
                document.getElementById('cross-status').className = 'status-indicator status-updated';
                
            } catch (error) {
                console.error('Erro ao carregar os dados da tabela:', error);
                
                // Atualizar status para erro
                document.getElementById('cross-status').innerHTML = `
                    <i class="fas fa-exclamation-circle status-icon"></i>
                    <span>Erro no cruzamento: ${error.message}</span>
                `;
                document.getElementById('cross-status').className = 'status-indicator status-not-updated';
            }

            spinner_desabilitar(id_spinner);
        }

        // =================================================================================================
        // CARREGA A TABELA HTML DAS BASES DE DADOS E SUAS COMPETÊNCIAS
        // =================================================================================================
        async function carregarTabelaCargas() {
            try {
                const response = await fetch('/api/cargas');
                if (!response.ok) {
                    throw new Error('Erro ao buscar os dados');
                }
                const data = await response.json();

                const tbody = document.getElementById('tabela-cargas');
                tbody.innerHTML = ''; // Limpa antes de preencher
                
                let totalRecords = 0;
                let lastUpdate = null;

                if (data.length > 0) {
                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="text-align: center;">${row.data_competencia}</td>
                            <td>${row.base_dados}</td>
                            <td style="text-align: right;">${parseInt(row.qtd_registros).toLocaleString('pt-BR')}</td>
                        `;
                        tbody.appendChild(tr);
                        
                        // Soma o total de registros
                        totalRecords += parseInt(row.qtd_registros);
                        
                        // Encontra a data mais recente
                        const rowDate = new Date(row.data_competencia);
                        if (!lastUpdate || rowDate > lastUpdate) {
                            lastUpdate = rowDate;
                        }
                    });
                    
                    // Atualiza o card de registros totais
                    document.getElementById('total-records').textContent = totalRecords.toLocaleString('pt-BR');
                    
                    // Atualiza o card de última atualização
                    if (lastUpdate) {
                        document.getElementById('last-update').textContent = 
                            lastUpdate.toLocaleDateString('pt-BR');
                    } else {
                        document.getElementById('last-update').textContent = '--';
                    }
                } else {
                    document.getElementById('total-records').textContent = '--';
                    document.getElementById('last-update').textContent = '--';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="3" style="text-align: center; font-style: italic;">
                            Nenhuma carga de dados encontrada
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                
                // Atualizar status das bases
                atualizarStatusBases(data);
            } catch (error) {
                console.error('Erro ao carregar os dados da tabela:', error);
                document.getElementById('total-records').textContent = '--';
                document.getElementById('last-update').textContent = '--';
            }
        }

        // =================================================================================================
        // ATUALIZAR STATUS DAS BASES
        // =================================================================================================
        function atualizarStatusBases(data) {
            // Verificar se há dados nas bases
            const hasServidores = data.some(row => row.base_dados.includes('servidores'));
            const hasBF = data.some(row => row.base_dados.includes('Bolsa Família'));
            const hasBPC = data.some(row => row.base_dados.includes('BPC'));
            const hasDefeso = data.some(row => row.base_dados.includes('Seguro-Defeso'));
            
            // Atualizar status da base de servidores
            if (hasServidores) {
                document.getElementById('server-status').innerHTML = `
                    <i class="fas fa-check-circle status-icon"></i>
                    <span>Base de servidores atualizada</span>
                `;
                document.getElementById('server-status').className = 'status-indicator status-updated';
            } else {
                document.getElementById('server-status').innerHTML = `
                    <i class="fas fa-exclamation-circle status-icon"></i>
                    <span>Base de servidores não atualizada</span>
                `;
                document.getElementById('server-status').className = 'status-indicator status-not-updated';
            }
            
            // Atualizar status das bases sociais
            if (hasBF && hasBPC && hasDefeso) {
                document.getElementById('social-status').innerHTML = `
                    <i class="fas fa-check-circle status-icon"></i>
                    <span>Bases sociais atualizadas</span>
                `;
                document.getElementById('social-status').className = 'status-indicator status-updated';
            } else if (hasBF || hasBPC || hasDefeso) {
                document.getElementById('social-status').innerHTML = `
                    <i class="fas fa-sync-alt status-icon"></i>
                    <span>Bases sociais parcialmente atualizadas</span>
                `;
                document.getElementById('social-status').className = 'status-indicator status-in-progress';
            } else {
                document.getElementById('social-status').innerHTML = `
                    <i class="fas fa-exclamation-circle status-icon"></i>
                    <span>Bases sociais não atualizadas</span>
                `;
                document.getElementById('social-status').className = 'status-indicator status-not-updated';
            }
        }

        // =================================================================================================
        // CARREGA A TABELA HTML DOS ACHADOS DO CRUZAMENTO
        // =================================================================================================
        async function carregarTabelaCruzamentos() {
            try {
                const response = await fetch('/api/resultadoscruzamentos');
                if (!response.ok) {
                    throw new Error('Erro ao buscar os dados');
                }
                const data = await response.json();

                const tbody = document.getElementById('tabela-cruzamentos');
                tbody.innerHTML = ''; // Limpa antes de preencher
                
                let totalFinds = 0;

                // Filtrar apenas os 3 benefícios específicos
                const beneficiosPermitidos = ["Bolsa Família", "BPC", "Seguro-Defeso"];
                const dadosFiltrados = data.filter(row => beneficiosPermitidos.includes(row.base));

                if (dadosFiltrados.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="3" style="text-align: center; font-style: italic;">
                            Nenhum cruzamento realizado ainda
                        </td>
                    `;
                    tbody.appendChild(tr);
                    
                    // Atualiza o card de achados totais
                    document.getElementById('total-finds').textContent = '--';
                } else {
                    dadosFiltrados.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="text-align: center;">${row.data_cruzamento}</td>
                            <td>${row.base}</td>
                            <td style="text-align: center;">${parseInt(row.qtd).toLocaleString('pt-BR')}</td>
                        `;
                        tbody.appendChild(tr);
                        
                        // Soma o total de achados
                        totalFinds += parseInt(row.qtd);
                    });
                    
                    // Atualiza o card de achados totais
                    document.getElementById('total-finds').textContent = totalFinds.toLocaleString('pt-BR');
                }

                // Carrega Gráfico dos achados
                carregarGraficoAchados(dadosFiltrados);
            } catch (error) {
                console.error('Erro ao carregar os dados da tabela:', error);
                document.getElementById('total-finds').textContent = '--';
            }
        }

        // =================================================================================================
        // INICIAR CONTAGEM REGRESSIVA
        // =================================================================================================
        function iniciarCountdown() {
            // Mostrar contador
            document.getElementById('countdown-container').style.display = 'block';
            
            // Definir tempo inicial (10 minutos)
            countdownSeconds = 600;
            
            // Atualizar status
            document.getElementById('social-status').innerHTML = `
                <i class="fas fa-sync-alt fa-spin status-icon"></i>
                <span>Atualização em andamento...</span>
            `;
            document.getElementById('social-status').className = 'status-indicator status-in-progress';
            
            // Limpar intervalo anterior se existir
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // Iniciar novo intervalo
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                
                // Formatar minutos e segundos
                const minutes = Math.floor(countdownSeconds / 60);
                const seconds = countdownSeconds % 60;
                
                // Atualizar display
                document.getElementById('countdown').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Verificar se terminou
                if (countdownSeconds <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown-container').style.display = 'none';
                    document.getElementById('social-status').innerHTML = `
                        <i class="fas fa-check-circle status-icon"></i>
                        <span>Atualização concluída com sucesso!</span>
                    `;
                    document.getElementById('social-status').className = 'status-indicator status-updated';
                    
                    // Atualizar tabela de cargas
                    carregarTabelaCargas();
                }
            }, 1000);
        }

        // =================================================================================================
        // FUNÇÃO QUE ATUALIZA A BASE DE BENEFÍCIOS FEDERAIS NO BANCO DE DADOS 
        // =================================================================================================
        async function atualizarBaseFederal() {
            const id_spinner = "spinner_atualizar_base_social";
            spinner_habilitar(id_spinner);
            
            // Iniciar contagem regressiva
            iniciarCountdown();

            try {
                const response = await fetch('/update');

                if (!response.ok) {
                    throw new Error('Erro ao buscar os dados');
                }

                const data = await response.json();
                console.log(data);
                
            } catch (error) {
                console.error('Erro ao carregar os dados da tabela:', error);
                
                // Parar contagem regressiva
                clearInterval(countdownInterval);
                document.getElementById('countdown-container').style.display = 'none';
                
                // Atualizar status para erro
                document.getElementById('social-status').innerHTML = `
                    <i class="fas fa-exclamation-circle status-icon"></i>
                    <span>Erro na atualização: ${error.message}</span>
                `;
                document.getElementById('social-status').className = 'status-indicator status-not-updated';
            }

            spinner_desabilitar(id_spinner);
        }

        // =================================================================================================
        // ENVIA PLANILHA DE SERVIDORES PARA BASE DE DADOS (CORRIGIDA)
        // =================================================================================================
        async function enviarPlanilhaServidores() {
            const id_spinner = "spinner_btn_upload_servidor";
            const input = document.getElementById('arquivo');
            const status = document.getElementById('status-upload');

            spinner_habilitar(id_spinner);

            if (input.files.length === 0) {
                status.innerHTML = '<div class="alert alert-warning">Nenhum arquivo selecionado.</div>';
                spinner_desabilitar(id_spinner);
                return;
            }

            const file = input.files[0];
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            const fileExtension = file.name.split('.').pop().toLowerCase();
            const allowedExtensions = ['csv', 'xls', 'xlsx'];

            // Verificar extensão do arquivo
            if (!allowedExtensions.includes(fileExtension)) {
                status.innerHTML = '<div class="alert alert-danger">Tipo de arquivo inválido. Use CSV, XLS ou XLSX.</div>';
                spinner_desabilitar(id_spinner);
                return;
            }

            // Verificar tamanho do arquivo (limite de 50MB)
            if (file.size > 50 * 1024 * 1024) {
                status.innerHTML = `<div class="alert alert-danger">Arquivo muito grande (${fileSizeMB} MB). O tamanho máximo permitido é 50MB.</div>`;
                spinner_desabilitar(id_spinner);
                return;
            }

            const formData = new FormData();
            formData.append('arquivo', file);

            try {
                const response = await fetch('/upload_servidores', {
                    method: 'POST',
                    body: formData
                });

                // Verificar se a resposta é JSON
                let responseData;
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    const textResponse = await response.text();
                    throw new Error(textResponse || "Resposta inválida do servidor");
                }

                if (!response.ok) {
                    throw new Error(responseData.message || "Erro no upload");
                }

                status.innerHTML = '<div class="alert alert-success">Upload feito com sucesso! Processando dados...</div>';

                // Simular processamento
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                status.innerHTML = '<div class="alert alert-success">Dados processados com sucesso!</div>';
                
                // Atualizar status
                document.getElementById('server-status').innerHTML = `
                    <i class="fas fa-check-circle status-icon"></i>
                    <span>Base atualizada em ${new Date().toLocaleDateString()}</span>
                `;
                document.getElementById('server-status').className = 'status-indicator status-updated';

                // Forçar atualização imediata da tabela de cargas
                await carregarTabelaCargas();
                
            } catch (err) {
                status.innerHTML = '<div class="alert alert-danger">Erro no upload: ' + err.message + '</div>';
            } finally {
                spinner_desabilitar(id_spinner);
            }              
        }

        // =================================================================================================
        // FUNÇÕES AUXILIARES PARA MANIPULAÇÃO DO DOM
        // =================================================================================================

        // =================================================================================================
        // HABILITA O SPINNER DE CARREGAMENTO
        // =================================================================================================
        async function spinner_habilitar(id_spinner) {
            const spinner = document.getElementById(id_spinner);
            spinner.style.display = "inline-block";
        }

        // =================================================================================================
        // DESABILITA O SPINNER DE CARREGAMENTO
        // =================================================================================================
        async function spinner_desabilitar(id_spinner) {
            const spinner = document.getElementById(id_spinner);
            spinner.style.display = "none";        
        }

        // =================================================================================================
        // INICIALIZAÇÃO DA PÁGINA
        // =================================================================================================
        window.onload = function () {
            // Carregar tabela de cargas imediatamente
            carregarTabelaCargas();
            
            // Configurar atualização automática da tabela de cargas a cada 5 segundos
            setInterval(carregarTabelaCargas, 5000);
            
            // Carregar tabela de cruzamentos vazia
            carregarTabelaCruzamentos();
            
            // Inicializar gráfico vazio
            carregarGraficoAchados([]);
        };
    </script>
</body>
</html>
